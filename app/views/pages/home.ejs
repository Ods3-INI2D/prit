<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/estilo.css">
    <link rel="stylesheet" href="/css/home.css">
    <link rel="stylesheet" href="/css/bloco.css">
    <link rel="stylesheet" href="/css/carousel.css">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme.js"></script>
</head>
<body>
    <header>
        <%- include('../partial/grid.ejs') %>
    </header>

    <main>
        <section class="carousel-container" aria-label="Carrossel de destaques">
            <% if(banners && banners.length > 0) { %>
                <% banners.forEach(function(banner, index) { %>
                    <figure class="carousel-slide <%= index === 0 ? 'active' : '' %>" aria-hidden="<%= index === 0 ? 'false' : 'true' %>">
                        <a href="<%= banner.link || '/home' %>" class="carousel-link" aria-label="<%= banner.legenda %>">
                            <img src="<%= banner.imagem %>" alt="<%= banner.legenda %>">
                            <figcaption class="carousel-caption"><%= banner.legenda %></figcaption>
                        </a>
                    </figure>
                <% }); %>
            <% } %>

            <nav class="carousel-controls" aria-label="Controles do carrossel">
                <button class="carousel-btn prev" aria-label="Slide anterior">❮</button>
                <button class="carousel-btn next" aria-label="Próximo slide">❯</button>
            </nav>

            <nav class="carousel-indicators" aria-label="Indicadores do carrossel">
                <% if(banners && banners.length > 0) { %>
                    <% banners.forEach(function(banner, index) { %>
                        <button class="indicator <%= index === 0 ? 'active' : '' %>" 
                                aria-label="Ir para slide <%= index + 1 %>" 
                                data-slide="<%= index %>"></button>
                    <% }); %>
                <% } %>
            </nav>
        </section>

        <% if(produtos && produtos.length > 0) { %>
            <%
            var produtosPorCategoria = {
                'Descontos': [],
                'Cuidados com a Pele': [],
                'Higiene Bucal': [],
                'Cabelo': [],
                'Vitaminas e Suplementos': [],
                'Terceira Idade': []
            };

            produtos.forEach(function(produto) {
                if(produto.precoDesconto) {
                    produtosPorCategoria['Descontos'].push(produto);
                }
                if(produtosPorCategoria[produto.categoria]) {
                    produtosPorCategoria[produto.categoria].push(produto);
                }
            });

            var descontosBalanceados = [];
            var categoriasPrincipais = ['Cuidados com a Pele', 'Higiene Bucal', 'Cabelo', 'Vitaminas e Suplementos', 'Terceira Idade'];
            
            categoriasPrincipais.forEach(function(cat) {
                var produtoCategoria = produtosPorCategoria['Descontos'].find(function(p) {
                    return p.categoria === cat;
                });
                if(produtoCategoria && descontosBalanceados.length < 8) {
                    descontosBalanceados.push(produtoCategoria);
                }
            });

            produtosPorCategoria['Descontos'].forEach(function(p) {
                if(descontosBalanceados.length < 8 && !descontosBalanceados.includes(p)) {
                    descontosBalanceados.push(p);
                }
            });

            produtosPorCategoria['Descontos'] = descontosBalanceados;
            %>

            <% if(produtosPorCategoria['Descontos'].length > 0) { %>
                <section class="secao-categoria" aria-labelledby="titulo-descontos">
                    <header class="header-categoria">
                        <h2 id="titulo-descontos" class="titulo-categoria">Descontos</h2>
                        <a href="/home" class="link-ver-mais">
                            <output>Ver mais</output>
                            <img src="/imagens/setal.png" alt="" class="seta-ver-mais">
                        </a>
                    </header>

                    <section class="produtos-container produtos-descontos">
                        <% produtosPorCategoria['Descontos'].slice(0, 8).forEach(function(produto) { 
                            var precoAtual = produto.preco || 0;
                            var precoComDesconto = produto.precoDesconto || null;
                            var temDesconto = precoComDesconto !== null && precoComDesconto > 0;
                            var percentualDesconto = 0;
                            
                            if(temDesconto && precoAtual > 0) {
                                percentualDesconto = Math.round(((precoAtual - precoComDesconto) / precoAtual) * 100);
                            }
                            
                            var temAvaliacoes = produto.avaliacoes && produto.avaliacoes.length > 0;
                            var notaArredondada = 0;
                            
                            if(temAvaliacoes) {
                                var somaNotas = 0;
                                produto.avaliacoes.forEach(function(avaliacao) {
                                    somaNotas += avaliacao.nota;
                                });
                                var media = somaNotas / produto.avaliacoes.length;
                                notaArredondada = Math.round(media);
                            }
                        %>
                            <article class="bloco-produto-home">
                                <a href="/produto/<%= produto.id %>" class="link-produto-home">
                                    <img src="<%= produto.imagem %>" alt="<%= produto.nome %>" class="imagem-produto-home">
                                    <h3 class="nome-produto-home"><%= produto.nome %></h3>

                                    <% if(temDesconto) { %>
                                        <section class="preco-container-home">
                                            <output class="preco-original-home">R$ <%= precoAtual.toFixed(2) %></output>
                                            <output class="preco-desconto-home">R$ <%= precoComDesconto.toFixed(2) %></output>
                                            <aside class="badge-desconto">
                                                <output class="percentual-home">-<%= percentualDesconto %>%</output>
                                            </aside>
                                        </section>
                                    <% } else { %>
                                        <output class="preco-unico-home">R$ <%= precoAtual.toFixed(2) %></output>
                                    <% } %>

                                    <output class="categoria-home"><%= produto.categoria %></output>

                                    <% if(temAvaliacoes) { %>
                                        <section class="estrelas-home">
                                            <% for(var i = 1; i <= 5; i++) { %>
                                                <img src="/imagens/estr<%= i <= notaArredondada ? '' : 'v' %>.png" alt="Estrela" class="estrela-home">
                                            <% } %>
                                        </section>
                                    <% } %>
                                </a>
                            </article>
                        <% }); %>
                    </section>
                </section>
            <% } %>

            <% categoriasPrincipais.forEach(function(nomeCategoria) { 
                if(produtosPorCategoria[nomeCategoria].length > 0) { 
                    var idCategoria = nomeCategoria.toLowerCase().replace(/\s+/g, '-');
            %>
                <section class="secao-categoria" aria-labelledby="titulo-<%= idCategoria %>">
                    <header class="header-categoria">
                        <h2 id="titulo-<%= idCategoria %>" class="titulo-categoria"><%= nomeCategoria %></h2>
                        <a href="/categoria/<%= encodeURIComponent(nomeCategoria) %>" class="link-ver-mais">
                            <output>Ver mais</output>
                            <img src="/imagens/setal.png" alt="" class="seta-ver-mais">
                        </a>
                    </header>

                    <section class="produtos-container">
                        <% produtosPorCategoria[nomeCategoria].slice(0, 4).forEach(function(produto) { 
                            var precoAtual = produto.preco || 0;
                            var precoComDesconto = produto.precoDesconto || null;
                            var temDesconto = precoComDesconto !== null && precoComDesconto > 0;
                            var percentualDesconto = 0;
                            
                            if(temDesconto && precoAtual > 0) {
                                percentualDesconto = Math.round(((precoAtual - precoComDesconto) / precoAtual) * 100);
                            }
                            
                            var temAvaliacoes = produto.avaliacoes && produto.avaliacoes.length > 0;
                            var notaArredondada = 0;
                            
                            if(temAvaliacoes) {
                                var somaNotas = 0;
                                produto.avaliacoes.forEach(function(avaliacao) {
                                    somaNotas += avaliacao.nota;
                                });
                                var media = somaNotas / produto.avaliacoes.length;
                                notaArredondada = Math.round(media);
                            }
                        %>
                            <article class="bloco-produto-home">
                                <a href="/produto/<%= produto.id %>" class="link-produto-home">
                                    <img src="<%= produto.imagem %>" alt="<%= produto.nome %>" class="imagem-produto-home">
                                    <h3 class="nome-produto-home"><%= produto.nome %></h3>

                                    <% if(temDesconto) { %>
                                        <section class="preco-container-home">
                                            <output class="preco-original-home">R$ <%= precoAtual.toFixed(2) %></output>
                                            <output class="preco-desconto-home">R$ <%= precoComDesconto.toFixed(2) %></output>
                                            <aside class="badge-desconto">
                                                <output class="percentual-home">-<%= percentualDesconto %>%</output>
                                            </aside>
                                        </section>
                                    <% } else { %>
                                        <output class="preco-unico-home">R$ <%= precoAtual.toFixed(2) %></output>
                                    <% } %>

                                    <output class="categoria-home"><%= produto.categoria %></output>

                                    <% if(temAvaliacoes) { %>
                                        <section class="estrelas-home">
                                            <% for(var i = 1; i <= 5; i++) { %>
                                                <img src="/imagens/estr<%= i <= notaArredondada ? '' : 'v' %>.png" alt="Estrela" class="estrela-home">
                                            <% } %>
                                        </section>
                                    <% } %>
                                </a>
                            </article>
                        <% }); %>
                    </section>
                </section>
            <% } 
            }); %>

        <% } else { %>
            <article class="sem-produtos">
                <output class="mensagem-vazio">Nenhum produto disponível no momento.</output>
                <% if(isAdmin) { %>
                    <a href="/admin" class="btn-admin">Gerenciar o Site</a>
                <% } %>
            </article>
        <% } %>
    </main>

    <footer>
        <%- include('../partial/footer.ejs') %>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var slides = document.querySelectorAll('.carousel-slide');
            var prevBtn = document.querySelector('.carousel-btn.prev');
            var nextBtn = document.querySelector('.carousel-btn.next');
            var indicators = document.querySelectorAll('.indicator');
            var currentSlide = 0;
            var autoPlayInterval;

            if(slides.length === 0) return;

            function showSlide(n) {
                for(var i = 0; i < slides.length; i++) {
                    slides[i].classList.remove('active');
                    slides[i].setAttribute('aria-hidden', 'true');
                }
                for(var i = 0; i < indicators.length; i++) {
                    indicators[i].classList.remove('active');
                }

                currentSlide = (n + slides.length) % slides.length;
                
                slides[currentSlide].classList.add('active');
                slides[currentSlide].setAttribute('aria-hidden', 'false');
                if(indicators[currentSlide]) {
                    indicators[currentSlide].classList.add('active');
                }
            }

            function nextSlide() {
                showSlide(currentSlide + 1);
            }

            function prevSlide() {
                showSlide(currentSlide - 1);
            }

            function startAutoPlay() {
                autoPlayInterval = setInterval(nextSlide, 5000);
            }

            function stopAutoPlay() {
                clearInterval(autoPlayInterval);
            }

            if(prevBtn) {
                prevBtn.addEventListener('click', function() {
                    prevSlide();
                    stopAutoPlay();
                    startAutoPlay();
                });
            }

            if(nextBtn) {
                nextBtn.addEventListener('click', function() {
                    nextSlide();
                    stopAutoPlay();
                    startAutoPlay();
                });
            }

            for(var i = 0; i < indicators.length; i++) {
                indicators[i].addEventListener('click', function() {
                    var index = parseInt(this.getAttribute('data-slide'));
                    showSlide(index);
                    stopAutoPlay();
                    startAutoPlay();
                });
            }

            startAutoPlay();

            var carouselContainer = document.querySelector('.carousel-container');
            if(carouselContainer) {
                carouselContainer.addEventListener('mouseenter', stopAutoPlay);
                carouselContainer.addEventListener('mouseleave', startAutoPlay);
            }
        });
    </script>
</body>
</html>