<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador - Painel de Controle</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/admin-extended.css">
</head>
<body>
    <header>
        <img src="/imagens/logo.png" alt="Logotipo da Farmácia" class="logo">
        <h1 class="titulo">Painel Administrativo</h1>
    </header>
 
    <main>
        <% 
        const queryString = typeof window !== 'undefined' ? window.location.search : '';
        const sucesso = queryString.includes('sucesso=produto_adicionado') ? 'produto_adicionado' :
                       queryString.includes('sucesso=produto_editado') ? 'produto_editado' :
                       queryString.includes('sucesso=produto_excluido') ? 'produto_excluido' :
                       queryString.includes('sucesso=usuario_excluido') ? 'usuario_excluido' :
                       queryString.includes('sucesso=banner_editado') ? 'banner_editado' : null;
        const erro = queryString.includes('erro=adicionar_produto') ? 'adicionar_produto' :
                    queryString.includes('erro=editar_produto') ? 'editar_produto' :
                    queryString.includes('erro=excluir_produto') ? 'excluir_produto' :
                    queryString.includes('erro=produto_nao_encontrado') ? 'produto_nao_encontrado' :
                    queryString.includes('erro=excluir_usuario') ? 'excluir_usuario' :
                    queryString.includes('erro=editar_banner') ? 'editar_banner' :
                    queryString.includes('erro=banner_nao_encontrado') ? 'banner_nao_encontrado' : null;
        %>

        <% if(sucesso === 'produto_adicionado') { %>
            <output class="mensagem-sucesso" role="status" aria-live="polite">
                Produto adicionado com sucesso!
            </output>
        <% } else if(sucesso === 'produto_editado') { %>
            <output class="mensagem-sucesso" role="status" aria-live="polite">
                Produto editado com sucesso!
            </output>
        <% } else if(sucesso === 'produto_excluido') { %>
            <output class="mensagem-sucesso" role="status" aria-live="polite">
                Produto excluído com sucesso!
            </output>
        <% } else if(sucesso === 'usuario_excluido') { %>
            <output class="mensagem-sucesso" role="status" aria-live="polite">
                Usuário excluído com sucesso!
            </output>
        <% } else if(sucesso === 'banner_editado') { %>
            <output class="mensagem-sucesso" role="status" aria-live="polite">
                Banner editado com sucesso!
            </output>
        <% } %>

        <% if(erro === 'adicionar_produto') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Erro ao adicionar produto!
            </output>
        <% } else if(erro === 'editar_produto') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Erro ao editar produto!
            </output>
        <% } else if(erro === 'excluir_produto') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Erro ao excluir produto!
            </output>
        <% } else if(erro === 'produto_nao_encontrado') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Produto não encontrado!
            </output>
        <% } else if(erro === 'excluir_usuario') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Erro ao excluir usuário!
            </output>
        <% } else if(erro === 'editar_banner') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Erro ao editar banner!
            </output>
        <% } else if(erro === 'banner_nao_encontrado') { %>
            <output class="mensagem-erro" role="alert" aria-live="assertive">
                Banner não encontrado!
            </output>
        <% } %>

        <section class="estatisticas" aria-labelledby="titulo-estatisticas">
            <h2 id="titulo-estatisticas" class="subtitulo">Estatísticas do Site</h2>
            
            <section class="estatisticas-grid">
                <article class="card-stats">
                    <h3 class="stat-titulo">Total de Produtos</h3>
                    <output class="stat-valor" aria-label="<%= totalProdutos %> produtos cadastrados"><%= totalProdutos %></output>
                </article>

                <article class="card-stats">
                    <h3 class="stat-titulo">Total de Usuários</h3>
                    <output class="stat-valor" aria-label="<%= usuarios.length %> usuários cadastrados"><%= usuarios.length %></output>
                </article>
            </section>
        </section>

        <section class="tabs-container">
            <nav class="tabs-header" role="tablist">
                <button class="tab-button active" data-tab="adicionar" role="tab" aria-selected="true" aria-controls="tab-adicionar">Adicionar Produto</button>
                <button class="tab-button" data-tab="produtos" role="tab" aria-selected="false" aria-controls="tab-produtos">Gerenciar Produtos</button>
                <button class="tab-button" data-tab="usuarios" role="tab" aria-selected="false" aria-controls="tab-usuarios">Gerenciar Usuários</button>
                <button class="tab-button" data-tab="banners" role="tab" aria-selected="false" aria-controls="tab-banners">Gerenciar Banners</button>
            </nav>

            <article class="tab-content active" id="tab-adicionar" role="tabpanel" aria-labelledby="titulo-adicionar">
                <section class="adicionar-produto">
                    <h2 id="titulo-adicionar" class="subtitulo">Adicionar Novo Produto</h2>
                    
                    <form method="POST" action="/admin/adicionar-produto" class="form-produto" enctype="multipart/form-data" aria-label="Formulário de cadastro de produto">
                        <fieldset>
                            <legend class="label-titulo">Nome do Produto</legend>
                            <label for="nome">
                                <input type="text" id="nome" name="nome" placeholder="Digite o nome do produto" required aria-required="true">
                            </label>
                        </fieldset>
         
                        <fieldset>
                            <legend class="label-titulo">Preço</legend>
                            <label for="preco">
                                <input type="number" id="preco" name="preco" placeholder="0.00" step="0.01" min="0" required aria-required="true">
                            </label>
                        </fieldset>
         
                        <fieldset>
                            <legend class="label-titulo">Preço com Desconto (opcional)</legend>
                            <label for="precoDesconto">
                                <input type="number" id="precoDesconto" name="precoDesconto" placeholder="0.00" step="0.01" min="0" aria-required="false">
                            </label>
                        </fieldset>
         
                        <fieldset>
                            <legend class="label-titulo">Categoria</legend>
                            <label for="categoria">
                                <select id="categoria" name="categoria" required aria-required="true">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Cuidados com a Pele">Cuidados com a Pele</option>
                                    <option value="Higiene Bucal">Higiene Bucal</option>
                                    <option value="Cabelo">Cabelo</option>
                                    <option value="Vitaminas e Suplementos">Vitaminas e Suplementos</option>
                                    <option value="Bebê">Bebê</option>
                                    <option value="Terceira Idade">Terceira Idade</option>
                                    <option value="Medicamentos">Medicamentos</option>
                                </select>
                            </label>
                        </fieldset>
         
                        <fieldset class="campo-imagem">
                            <legend>
                                <strong class="label-titulo">Imagem do Produto</strong>
                            </legend>
                            <label for="imagem" class="label-arquivo">
                                <input type="file"
                                       id="imagem"
                                       name="imagem"
                                       accept="image/jpeg,image/jpg,image/png,image/webp"
                                       aria-describedby="imagem-info">
                                <output id="imagem-info" class="info-arquivo">
                                    Formatos aceitos: JPG, JPEG, PNG, WEBP (máx. 5MB)
                                </output>
                            </label>
                            <output id="preview-imagem" class="preview-container" role="status" aria-live="polite"></output>
                        </fieldset>
         
                        <label for="descricao">
                            <strong class="label-titulo">Descrição do Produto</strong>
                            <textarea id="descricao" name="descricao" placeholder="Digite a descrição do produto" rows="5" required aria-required="true"></textarea>
                        </label>
         
                        <button type="submit" class="btn-adicionar">Adicionar Produto</button>
                    </form>
                </section>
            </article>

            <article class="tab-content" id="tab-produtos" role="tabpanel" aria-labelledby="titulo-lista">
                <section class="lista-produtos">
                    <h2 id="titulo-lista" class="subtitulo">Produtos Cadastrados</h2>
                    
                    <% if(produtos.length === 0) { %>
                        <output class="mensagem-vazia">Nenhum produto cadastrado ainda.</output>
                    <% } else { %>
                        <ul class="produtos-lista" role="list">
                            <% produtos.forEach(function(produto) { %>
                                <li class="produto-item" role="listitem">
                                    <article class="produto-info-container">
                                        <figure>
                                            <h3 class="produto-nome"><%= produto.nome %></h3>
                                            <figcaption class="produto-info">ID: <%= produto.id %></figcaption>
                                        </figure>
                                        <output class="produto-info">Categoria: <%= produto.categoria %></output>
                                        <output class="produto-info produto-preco">R$ <%= produto.preco.toFixed(2) %></output>
                                        <% if(produto.precoDesconto) { %>
                                            <output class="produto-info desconto">Com Desconto: R$ <%= produto.precoDesconto.toFixed(2) %></output>
                                        <% } %>
                                    </article>
                                    <nav class="acoes-produto" aria-label="Ações do produto <%= produto.nome %>">
                                        <a href="/admin/editar-produto/<%= produto.id %>" class="btn-editar" aria-label="Editar produto <%= produto.nome %>">Editar</a>
                                        <form method="POST" action="/admin/excluir-produto/<%= produto.id %>" class="form-inline">
                                            <button class="btn-excluir" type="submit" onclick="return confirm('Tem certeza que deseja excluir este produto?')" aria-label="Excluir produto <%= produto.nome %>">Excluir</button>
                                        </form>
                                    </nav>
                                </li>
                            <% }); %>
                        </ul>
                    <% } %>
                </section>
            </article>

            <article class="tab-content" id="tab-usuarios" role="tabpanel" aria-labelledby="titulo-usuarios">
                <section class="lista-usuarios-section">
                    <h2 id="titulo-usuarios" class="subtitulo">Usuários Cadastrados</h2>
                    
                    <% if(usuarios.length === 0) { %>
                        <output class="mensagem-vazia">Nenhum usuário cadastrado ainda.</output>
                    <% } else { %>
                        <ul class="usuarios-lista" role="list">
                            <% usuarios.forEach(function(usuario) { %>
                                <li class="usuario-item" role="listitem">
                                    <article class="usuario-info-container">
                                        <figure>
                                            <h3 class="usuario-email"><%= usuario.email %></h3>
                                            <figcaption class="usuario-info">Nome: <%= usuario.nome %></figcaption>
                                        </figure>
                                        <output class="usuario-info">CPF: <%= usuario.cpf %></output>
                                        <output class="usuario-info">Telefone: <%= usuario.tel %></output>
                                        <time class="usuario-info" datetime="<%= usuario.nasc %>">Nascimento: <%= new Date(usuario.nasc).toLocaleDateString('pt-BR') %></time>
                                    </article>
                                    <nav class="acoes-usuario" aria-label="Ações do usuário <%= usuario.email %>">
                                        <form method="POST" action="/admin/excluir-usuario/<%= encodeURIComponent(usuario.email) %>" class="form-inline">
                                            <button class="btn-excluir" type="submit" onclick="return confirm('Tem certeza que deseja excluir este usuário?')" aria-label="Excluir usuário <%= usuario.email %>">Excluir</button>
                                        </form>
                                    </nav>
                                </li>
                            <% }); %>
                        </ul>
                    <% } %>
                </section>
            </article>

            <article class="tab-content" id="tab-banners" role="tabpanel" aria-labelledby="titulo-banners">
                <section class="lista-banners-section">
                    <h2 id="titulo-banners" class="subtitulo">Gerenciar Banners do Carrossel</h2>
                    
                    <output class="mensagem-info">Edite os banners que aparecem no carrossel da página inicial. São 3 banners disponíveis. Você pode alterar a legenda, o link e/ou a imagem de cada banner.</output>
                    
                    <% if(banners && banners.length > 0) { %>
                        <ul class="usuarios-lista" role="list">
                            <% banners.forEach(function(banner, index) { %>
                                <li class="usuario-item" role="listitem">
                                    <article class="usuario-info-container">
                                        <figure>
                                            <img src="<%= banner.imagem %>" alt="<%= banner.legenda %>" style="max-width: 200px; height: auto; border-radius: 0.5rem;">
                                            <figcaption class="usuario-info">Banner <%= index + 1 %></figcaption>
                                        </figure>
                                        <output class="usuario-info">Legenda: <%= banner.legenda %></output>
                                        <output class="usuario-info">Link: <%= banner.link || '/home' %></output>
                                    </article>
                                    <nav class="acoes-usuario" aria-label="Ações do banner <%= index + 1 %>">
                                        <button class="btn-editar" 
                                                type="button" 
                                                data-banner-id="<%= banner.id %>"
                                                data-banner-legenda="<%= banner.legenda %>"
                                                data-banner-link="<%= banner.link || '/home' %>"
                                                onclick="abrirModalBanner(this.dataset.bannerId, this.dataset.bannerLegenda, this.dataset.bannerLink)"
                                                aria-label="Editar banner <%= index + 1 %>">Editar</button>
                                    </nav>
                                </li>
                            <% }); %>
                        </ul>
                    <% } else { %>
                        <output class="mensagem-vazia">Nenhum banner disponível.</output>
                    <% } %>
                </section>
            </article>
        </section>
    </main>
 
    <footer>
        <nav aria-label="Navegação do rodapé">
            <a href="/home" class="link-footer">Voltar ao Site</a>
        </nav>
    </footer>

    <aside id="modal-banner" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-titulo">
        <article class="modal-content">
            <h2 class="subtitulo" id="modal-titulo">Editar Banner</h2>
            
            <form method="POST" id="form-editar-banner" enctype="multipart/form-data" class="form-produto">
                <fieldset>
                    <legend class="label-titulo">Legenda do Banner</legend>
                    <label for="legenda-banner">
                        <input type="text" id="legenda-banner" name="legenda" placeholder="Digite a legenda" required>
                    </label>
                </fieldset>

                <fieldset>
                    <legend class="label-titulo">Link do Banner</legend>
                    <label for="link-banner">
                        <input type="text" id="link-banner" name="link" placeholder="/home ou /categoria/nome" required>
                    </label>
                    <output class="info-arquivo">
                        Exemplos: /home, /categoria/Cuidados com a Pele, /produto/123
                    </output>
                </fieldset>

                <fieldset class="campo-imagem">
                    <legend>
                        <strong class="label-titulo">Nova Imagem (opcional)</strong>
                    </legend>
                    <label for="imagem-banner" class="label-arquivo">
                        <input type="file"
                               id="imagem-banner"
                               name="imagem"
                               accept="image/jpeg,image/jpg,image/png,image/webp"
                               aria-describedby="banner-info">
                        <output id="banner-info" class="info-arquivo">
                            Formatos aceitos: JPG, JPEG, PNG, WEBP (máx. 5MB). Deixe em branco para manter a imagem atual.
                        </output>
                    </label>
                    <output id="preview-banner" class="preview-container" role="status" aria-live="polite"></output>
                </fieldset>

                <button type="submit" class="btn-adicionar">Salvar Alterações</button>
                <button type="button" class="btn-adicionar" onclick="fecharModalBanner()" style="background-color: #555; margin-top: 1rem;">Cancelar</button>
            </form>
        </article>
    </aside>
 
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');

                    tabButtons.forEach(function(btn) {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    tabContents.forEach(function(content) {
                        content.classList.remove('active');
                    });

                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    document.getElementById('tab-' + tabId).classList.add('active');
                });
            });

            const inputImagem = document.getElementById('imagem');
            const previewContainer = document.getElementById('preview-imagem');
            const infoArquivo = document.getElementById('imagem-info');
 
            if (inputImagem) {
                inputImagem.addEventListener('change', function(e) {
                    const arquivo = e.target.files[0];
                    
                    if (!arquivo) {
                        previewContainer.innerHTML = '';
                        infoArquivo.textContent = 'Formatos aceitos: JPG, JPEG, PNG, WEBP (máx. 5MB)';
                        infoArquivo.style.color = '';
                        return;
                    }
 
                    if (arquivo.size > 5 * 1024 * 1024) {
                        infoArquivo.textContent = 'Erro: A imagem deve ter no máximo 5MB';
                        infoArquivo.style.color = '#d93025';
                        previewContainer.innerHTML = '';
                        inputImagem.value = '';
                        return;
                    }
 
                    const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    if (!tiposPermitidos.includes(arquivo.type)) {
                        infoArquivo.textContent = 'Erro: Formato não suportado. Use JPG, PNG ou WEBP';
                        infoArquivo.style.color = '#d93025';
                        previewContainer.innerHTML = '';
                        inputImagem.value = '';
                        return;
                    }
 
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const figure = document.createElement('figure');
                        figure.className = 'preview-figure';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Preview da imagem do produto';
                        img.className = 'preview-img';
                        
                        const figcaption = document.createElement('figcaption');
                        figcaption.textContent = arquivo.name;
                        figcaption.className = 'preview-caption';
                        
                        figure.appendChild(img);
                        figure.appendChild(figcaption);
                        previewContainer.innerHTML = '';
                        previewContainer.appendChild(figure);
                        
                        infoArquivo.textContent = 'Imagem selecionada com sucesso!';
                        infoArquivo.style.color = '#4da6ff';
                    };
                    reader.readAsDataURL(arquivo);
                });
            }

            const inputBanner = document.getElementById('imagem-banner');
            const previewBanner = document.getElementById('preview-banner');
            const infoBanner = document.getElementById('banner-info');

            if (inputBanner) {
                inputBanner.addEventListener('change', function(e) {
                    const arquivo = e.target.files[0];
                    
                    if (!arquivo) {
                        previewBanner.innerHTML = '';
                        infoBanner.textContent = 'Formatos aceitos: JPG, JPEG, PNG, WEBP (máx. 5MB). Deixe em branco para manter a imagem atual.';
                        infoBanner.style.color = '';
                        return;
                    }

                    if (arquivo.size > 5 * 1024 * 1024) {
                        infoBanner.textContent = 'Erro: A imagem deve ter no máximo 5MB';
                        infoBanner.style.color = '#d93025';
                        previewBanner.innerHTML = '';
                        inputBanner.value = '';
                        return;
                    }

                    const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    if (!tiposPermitidos.includes(arquivo.type)) {
                        infoBanner.textContent = 'Erro: Formato não suportado. Use JPG, PNG ou WEBP';
                        infoBanner.style.color = '#d93025';
                        previewBanner.innerHTML = '';
                        inputBanner.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const figure = document.createElement('figure');
                        figure.className = 'preview-figure';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Preview da nova imagem do banner';
                        img.className = 'preview-img';
                        
                        const figcaption = document.createElement('figcaption');
                        figcaption.textContent = arquivo.name;
                        figcaption.className = 'preview-caption';
                        
                        figure.appendChild(img);
                        figure.appendChild(figcaption);
                        previewBanner.innerHTML = '';
                        previewBanner.appendChild(figure);
                        
                        infoBanner.textContent = 'Nova imagem selecionada com sucesso!';
                        infoBanner.style.color = '#4da6ff';
                    };
                    reader.readAsDataURL(arquivo);
                });
            }
        });

        function abrirModalBanner(id, legenda, link) {
            const modal = document.getElementById('modal-banner');
            const form = document.getElementById('form-editar-banner');
            const inputLegenda = document.getElementById('legenda-banner');
            const inputLink = document.getElementById('link-banner');
            const previewBanner = document.getElementById('preview-banner');
            const inputBanner = document.getElementById('imagem-banner');
            const infoBanner = document.getElementById('banner-info');
            
            previewBanner.innerHTML = '';
            inputBanner.value = '';
            infoBanner.textContent = 'Formatos aceitos: JPG, JPEG, PNG, WEBP (máx. 5MB). Deixe em branco para manter a imagem atual.';
            infoBanner.style.color = '';
            
            form.action = '/admin/editar-banner/' + id;
            inputLegenda.value = legenda;
            inputLink.value = link || '/home';
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function fecharModalBanner() {
            const modal = document.getElementById('modal-banner');
            const form = document.getElementById('form-editar-banner');
            const inputBanner = document.getElementById('imagem-banner');
            const previewBanner = document.getElementById('preview-banner');
            const infoBanner = document.getElementById('banner-info');
            
            form.reset();
            inputBanner.value = '';
            previewBanner.innerHTML = '';
            infoBanner.textContent = 'Formatos aceitos: JPG, JPEG, PNG, WEBP (máx. 5MB). Deixe em branco para manter a imagem atual.';
            infoBanner.style.color = '';
            
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('modal-banner').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalBanner();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal-banner');
                if (modal.classList.contains('active')) {
                    fecharModalBanner();
                }
            }
        });
    </script>
</body>
</html>