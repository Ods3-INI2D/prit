<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= produto.nome %></title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/produto.css">
    <script src="/js/validacao.js" defer></script>
</head>
<body>
    <header>
        <%- include('../partial/grid.ejs') %>
    </header>

    <main>
        <nav class="navegacao">
            <a href="/home" class="voltar">
                <img src="/imagens/setae.png" alt="Voltar" class="seta-voltar">
                Voltar
            </a>
        </nav>

        <section class="produto-detalhes">
            <img src="<%= produto.imagem %>" class="imagem-produto" alt="<%= produto.nome %>">
            
            <article class="info-principal">
                <h1 class="nome-produto"><%= produto.nome %></h1>
                
                <p class="categoria-produto"><%= produto.categoria %></p>
                
                <% if(produto.precoDesconto) { %>
                    <section class="preco-container com-desconto">
                        <p class="preco-original">R$ <%= produto.preco.toFixed(2) %></p>
                        <p class="preco-desconto">R$ <%= produto.precoDesconto.toFixed(2) %></p>
                        <p class="percentual-desconto">
                            -<%= Math.round(((produto.preco - produto.precoDesconto) / produto.preco) * 100) %>%
                        </p>
                    </section>
                <% } else { %>
                    <p class="preco-produto">R$ <%= produto.preco.toFixed(2) %></p>
                <% } %>

                <form method="POST" action="/produto/<%= produto.id %>/adicionar-carrinho">
                    <button type="submit" class="btn-comprar">Comprar</button>
                </form>
            </article>
        </section>

        <section class="frete-container">
            <h2 class="titulo-secao">Cálculo de Frete e Prazo</h2>
            
            <p class="descricao-frete">Insira seu CEP para calcular o frete e o prazo para entrega do produto</p>
            
            <form class="form-frete">
                <label for="cep">
                    <input type="text" name="cep" id="cep" placeholder="Digite seu CEP" maxlength="8">
                </label>
                <button type="submit" class="btn-calcular">Calcular</button>
            </form>
        </section>

        <hr class="divisor">

        <section class="descricao-container">
            <h2 class="titulo-secao">Descrição do Produto</h2>
            <h3 class="nome-descricao"><%= produto.nome %></h3>
            <p class="texto-descricao"><%= produto.descricao %></p>
        </section>

        <hr class="divisor">

        <section class="avaliacoes-container" id="avaliar">
            <h2 class="titulo-secao">Avaliações</h2>
            
            <% if(produto.avaliacoes && produto.avaliacoes.length > 0) { %>
                <article class="nota-media">
                    <h3 class="label-nota">Nota Média</h3>
                    <% 
                    var somaNotas = 0;
                    produto.avaliacoes.forEach(function(avaliacao) {
                        somaNotas += avaliacao.nota;
                    });
                    var media = (somaNotas / produto.avaliacoes.length).toFixed(1);
                    var notaArredondada = Math.round(media);
                    %>
                    <section class="estrelas-media">
                        <% for(var i = 1; i <= 5; i++) { %>
                            <img src="/imagens/estr<%= i <= notaArredondada ? '' : 'v' %>.png" 
                                 class="estrela" 
                                 alt="Estrela <%= i <= notaArredondada ? 'preenchida' : 'vazia' %>">
                        <% } %>
                    </section>
                    <p class="valor-media"><%= media %></p>
                </article>

                <a href="#form-avaliacao" class="ver-mais">Ver todas as avaliações</a>

                <ul class="lista-avaliacoes">
                    <% produto.avaliacoes.forEach(function(avaliacao) { %>
                        <li class="item-avaliacao">
                            <section class="estrelas-avaliacao">
                                <% for(var i = 1; i <= 5; i++) { %>
                                    <img src="/imagens/estr<%= i <= avaliacao.nota ? '' : 'v' %>.png" 
                                         class="estrela-pequena" 
                                         alt="Estrela">
                                <% } %>
                            </section>
                            <p class="texto-avaliacao"><%= avaliacao.texto %></p>
                        </li>
                    <% }); %>
                </ul>
            <% } else { %>
                <p class="sem-avaliacoes">Ainda não há avaliações para este produto.</p>
            <% } %>

            <article class="form-avaliacao-container" id="form-avaliacao">
                <h3 class="titulo-form-avaliacao">Deixe sua avaliação</h3>
                
                <form method="POST" action="/produto/<%= produto.id %>/avaliar" class="form-avaliacao">
                    <label for="nota">
                        <h4 class="label-avaliacao">Nota (0 a 5 estrelas)</h4>
                        <select name="nota" id="nota" required>
                            <option value="">Selecione</option>
                            <option value="0">0 estrelas</option>
                            <option value="1">1 estrela</option>
                            <option value="2">2 estrelas</option>
                            <option value="3">3 estrelas</option>
                            <option value="4">4 estrelas</option>
                            <option value="5">5 estrelas</option>
                        </select>
                    </label>

                    <label for="texto">
                        <h4 class="label-avaliacao">Seu comentário</h4>
                        <textarea name="texto" id="texto" placeholder="Escreva sua avaliação" rows="4" required></textarea>
                    </label>

                    <button type="submit" class="btn-enviar-avaliacao">Enviar Avaliação</button>
                </form>
            </article>
        </section>

        <h2 class="titulo-outros">Outros Produtos</h2>

        <hr class="divisor">

        <section class="outros-produtos">
            <% produtos.slice(0, 4).forEach(function(outroProduto) { 
                if(outroProduto.id !== produto.id) { %>
                    <article class="bloco-produto">
                        <a href="/produto/<%= outroProduto.id %>" class="link-produto">
                            <img src="<%= outroProduto.imagem %>" class="img-produto-bloco" alt="<%= outroProduto.nome %>">
                            <h3 class="nome-produto-bloco"><%= outroProduto.nome %></h3>
                            <p class="preco-produto-bloco">R$ <%= (outroProduto.precoDesconto || outroProduto.preco).toFixed(2) %></p>
                        </a>
                    </article>
            <% }
            }); %>
        </section>
    </main>

    <footer>
        <%- include('../partial/footer.ejs') %>
    </footer>
</body>
</html>