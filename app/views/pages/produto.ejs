<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= produto.nome %></title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/produto.css">
    <style>
        .mensagem-aviso {
            background-color: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            color: #ffc107;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }

        .mensagem-erro-avaliacao {
            background-color: rgba(217, 48, 37, 0.2);
            border: 2px solid #d93025;
            color: #ff6b6b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }

        .mensagem-fora-estoque {
            background-color: rgba(217, 48, 37, 0.2);
            border: 2px solid #d93025;
            color: #ff6b6b;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .form-avaliacao-desabilitado {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
    <script src="/js/validacao.js" defer></script>
</head>
<body>
    <header>
        <%- include('../partial/grid.ejs') %>
    </header>

    <main>
        <nav class="navegacao">
            <a href="/home" class="voltar">
                <img src="/imagens/setae.png" alt="Voltar" class="seta-voltar">
                <output>Voltar</o>
            </a>
        </nav>

        <section class="produto-detalhes">
            <img src="<%= produto.imagem %>" class="imagem-produto" alt="<%= produto.nome %>">
            
            <article class="info-principal">
                <h1 class="nome-produto"><%= produto.nome %></h1>
                
                <output class="categoria-produto"><%= produto.categoria %></o>
                
                <% if(produto.precoDesconto) { %>
                    <section class="preco-container com-desconto">
                        <output class="preco-original">R$ <%= produto.preco.toFixed(2) %></o>
                        <output class="preco-desconto">R$ <%= produto.precoDesconto.toFixed(2) %></o>
                        <output class="percentual-desconto">
                            -<%= Math.round(((produto.preco - produto.precoDesconto) / produto.preco) * 100) %>%
                        </o>
                    </section>
                <% } else { %>
                    <output class="preco-produto">R$ <%= produto.preco.toFixed(2) %></o>
                <% } %>

                <% if(produto.status === 'fora-de-estoque') { %>
                    <output class="mensagem-fora-estoque" role="alert" aria-live="assertive">
                        ⚠️ Este produto está temporariamente fora de estoque
                    </o>
                <% } else { %>
                    <% if(usuarioLogado) { %>
                        <form method="POST" action="/produto/<%= produto.id %>/adicionar-carrinho">
                            <button type="submit" class="btn-comprar">
                                <%= temProdutoNoCarrinho ? 'Adicionar Mais ao Carrinho' : 'Adicionar ao Carrinho' %>
                            </button>
                        </form>
                    <% } else { %>
                        <a href="/login?redirect=/produto/<%= produto.id %>" class="btn-comprar" style="display: block; text-align: center; text-decoration: none;">
                            Fazer Login para Comprar
                        </a>
                    <% } %>
                <% } %>

                <% if(typeof erro !== 'undefined' && erro === 'fora_de_estoque') { %>
                    <output class="mensagem-erro-avaliacao" role="alert" aria-live="assertive">
                        Não é possível adicionar este produto ao carrinho pois está fora de estoque!
                    </o>
                <% } %>
            </article>
        </section>

        <section class="frete-container">
            <h2 class="titulo-secao">Cálculo de Frete e Prazo</h2>
            
            <output class="descricao-frete">Insira seu CEP para calcular o frete e o prazo para entrega do produto</o>
            
            <form class="form-frete">
                <label for="cep">
                    <input type="text" name="cep" id="cep" placeholder="Digite seu CEP" maxlength="8">
                </label>
                <button type="submit" class="btn-calcular">Calcular</button>
            </form>
        </section>

        <hr class="divisor">

        <section class="descricao-container">
            <h2 class="titulo-secao">Descrição do Produto</h2>
            <h3 class="nome-descricao"><%= produto.nome %></h3>
            <output class="texto-descricao"><%= produto.descricao %></o>
        </section>

        <hr class="divisor">

        <section class="avaliacoes-container" id="avaliar">
            <h2 class="titulo-secao">Avaliações</h2>
            
            <% if(produto.avaliacoes && produto.avaliacoes.length > 0) { %>
                <article class="nota-media">
                    <h3 class="label-nota">Nota Média</h3>
                    <% 
                    let somaNotas = 0;
                    produto.avaliacoes.forEach(function(avaliacao) {
                        somaNotas += avaliacao.nota;
                    });
                    let media = (somaNotas / produto.avaliacoes.length).toFixed(1);
                    let notaArredondada = Math.round(media);
                    %>
                    <section class="estrelas-media">
                        <% for(let i = 1; i <= 5; i++) { %>
                            <img src="/imagens/estr<%= i <= notaArredondada ? '' : 'v' %>.png" 
                                 class="estrela" 
                                 alt="Estrela <%= i <= notaArredondada ? 'preenchida' : 'vazia' %>">
                        <% } %>
                    </section>
                    <output class="valor-media"><%= media %></o>
                </article>

                <a href="#form-avaliacao" class="ver-mais">Ver todas as avaliações</a>

                <ul class="lista-avaliacoes">
                    <% produto.avaliacoes.forEach(function(avaliacao) { %>
                        <li class="item-avaliacao">
                            <section class="estrelas-avaliacao">
                                <% for(let i = 1; i <= 5; i++) { %>
                                    <img src="/imagens/estr<%= i <= avaliacao.nota ? '' : 'v' %>.png" 
                                         class="estrela-pequena" 
                                         alt="Estrela">
                                <% } %>
                            </section>
                            <output class="texto-avaliacao"><%= avaliacao.texto %></o>
                        </li>
                    <% }); %>
                </ul>
            <% } else { %>
                <output class="sem-avaliacoes">Ainda não há avaliações para este produto.</o>
            <% } %>

            <article class="form-avaliacao-container" id="form-avaliacao">
                <h3 class="titulo-form-avaliacao">Deixe sua avaliação</h3>
                
                <% if(!usuarioLogado) { %>
                    <output class="mensagem-aviso" role="alert">
                        Você precisa estar logado para avaliar este produto.
                        <a href="/login?redirect=/produto/<%= produto.id %>" style="color: #ffc107; text-decoration: underline;">Fazer login</a>
                    </o>
                <% } else if(!temProdutoNoCarrinho) { %>
                    <output class="mensagem-aviso" role="alert">
                        Você precisa adicionar este produto ao carrinho antes de avaliá-lo.
                    </o>
                <% } %>

                <% if(typeof erro !== 'undefined' && erro === 'carrinho') { %>
                    <output class="mensagem-erro-avaliacao" role="alert">
                        Erro: Você precisa ter este produto no carrinho para avaliá-lo!
                    </o>
                <% } %>
                
                <form method="POST" 
                      action="/produto/<%= produto.id %>/avaliar" 
                      class="form-avaliacao <%= (!usuarioLogado || !temProdutoNoCarrinho) ? 'form-avaliacao-desabilitado' : '' %>">
                    <label for="nota">
                        <h4 class="label-avaliacao">Nota (0 a 5 estrelas)</h4>
                        <select name="nota" id="nota" required <%= (!usuarioLogado || !temProdutoNoCarrinho) ? 'disabled' : '' %>>
                            <option value="">Selecione</option>
                            <option value="0">0 estrelas</option>
                            <option value="1">1 estrela</option>
                            <option value="2">2 estrelas</option>
                            <option value="3">3 estrelas</option>
                            <option value="4">4 estrelas</option>
                            <option value="5">5 estrelas</option>
                        </select>
                    </label>

                    <label for="texto">
                        <h4 class="label-avaliacao">Seu comentário</h4>
                        <textarea name="texto" 
                                  id="texto" 
                                  placeholder="Escreva sua avaliação" 
                                  rows="4" 
                                  required
                                  <%= (!usuarioLogado || !temProdutoNoCarrinho) ? 'disabled' : '' %>></textarea>
                    </label>

                    <button type="submit" 
                            class="btn-enviar-avaliacao"
                            <%= (!usuarioLogado || !temProdutoNoCarrinho) ? 'disabled' : '' %>>
                        Enviar Avaliação
                    </button>
                </form>
            </article>
        </section>

        <h2 class="titulo-outros">Outros Produtos</h2>

        <hr class="divisor">

        <section class="outros-produtos">
            <% produtos.slice(0, 4).forEach(function(outroProduto) { 
                if(outroProduto.id !== produto.id) { %>
                    <article class="bloco-produto">
                        <a href="/produto/<%= outroProduto.id %>" class="link-produto">
                            <img src="<%= outroProduto.imagem %>" class="img-produto-bloco" alt="<%= outroProduto.nome %>">
                            <h3 class="nome-produto-bloco"><%= outroProduto.nome %></h3>
                            <output class="preco-produto-bloco">R$ <%= (outroProduto.precoDesconto || outroProduto.preco).toFixed(2) %></o>
                        </a>
                    </article>
            <% }
            }); %>
        </section>
    </main>

    <footer>
        <%- include('../partial/footer.ejs') %>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('erro') === 'carrinho') {
            const formAvaliacao = document.getElementById('form-avaliacao');
            if (formAvaliacao) {
                formAvaliacao.scrollIntoView({ behavior: 'smooth' });
            }
        }
        if (urlParams.get('erro') === 'fora_de_estoque') {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>